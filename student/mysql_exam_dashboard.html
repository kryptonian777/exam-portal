<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MySQL Exam Dashboard</title>
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="../firebase-config.js"></script>
</head>
<body>
  <div class="container">
    <h2>Select a MySQL Chapter Exam</h2>
    <div id="examContainer">Loading chapters...</div>
  </div>

  <script>
    const chapterConfig = {
      "alter_table_add_modify_drop.json": { duration: 30, enabled: true },
      "aggregate_functions.json": { duration: 25, enabled: true },
      "joins.json": { duration: 20, enabled: false },
      "group_by_having.json": { duration: 25, enabled: true },
      "select_command.json": { duration: 30, enabled: true },
      "constraints.json": { duration: 25, enabled: true },
      "where_clause.json": { duration: 20, enabled: true },
      "create_table.json": { duration: 30, enabled: true },
      "drop_truncate.json": { duration: 25, enabled: false },
      "order_by.json": { duration: 20, enabled: true }
    };

    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "login.html";

    const userId = user.uid;
    const examContainer = document.getElementById("examContainer");

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      return `${hours}h ${minutes}m`;
    }

    function loadDashboard() {
      firebase.database().ref(`results/${userId}`).once("value", (snapshot) => {
        const data = snapshot.val() || {};

        const enabled = [],
          disabled = [];

        Object.keys(chapterConfig).forEach((filename) => {
          const { duration, enabled: isEnabled } = chapterConfig[filename];
          const chapterName = filename.replace(".json", "").replace(/_/g, " ").toUpperCase();
          const record = data[filename] || { attempts: 0, status: "Not Attempted" };
          const now = new Date().getTime();
          const isLocked = record.status === "Failed" && record.nextAttempt && now < record.nextAttempt;
          const timeLeft = isLocked ? formatTime(record.nextAttempt - now) : null;
          const percent = record.lastScore !== undefined ? record.lastScore + "%" : "-";

          const card = document.createElement("div");
          card.className = `card ${!isEnabled || isLocked ? "locked" : ""}`;

          card.innerHTML = `
            <h3>${chapterName}</h3>
            <p>Duration: ${duration} mins</p>
            <p>Attempts: ${record.attempts || 0}</p>
            <p>Status: ${record.status}</p>
            <p>Last Score: ${percent}</p>
            ${isLocked ? `<p class="countdown">‚è≥ Retry in: <span style='color:red'>${timeLeft}</span></p>` : ""}
            <button ${!isEnabled || isLocked ? "disabled" : ""} onclick="startExam('${filename}')">Start Exam</button>
          `;

          isEnabled && !isLocked ? enabled.push(card) : disabled.push(card);
        });

        examContainer.innerHTML = "";
        [...enabled, ...disabled].forEach((el) => examContainer.appendChild(el));
      });
    }

    function startExam(file) {
      localStorage.setItem("examFile", file);
      localStorage.setItem("examType", "mysql");
      window.location.href = "exam.html";
    }

    loadDashboard();
  </script>
</body>
</html>
