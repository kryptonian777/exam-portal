<script>
  let questions = [];
  let answers = {};
  let duration = 30 * 60;
  const timerElement = document.getElementById("timer");
  const subject = localStorage.getItem("selectedSubject");
  const examFile = localStorage.getItem("selectedExamFile");

  async function loadQuestions() {
    try {
      const res = await fetch(`../data/${subject}/${examFile}`);
      const data = await res.json();
      questions = data.questions;
      duration = (data.duration || 30) * 60;  // default 30 mins if not set
      renderQuestions();
      startTimer();
    } catch (err) {
      document.getElementById("exam-container").innerHTML = "❌ Error loading exam.";
    }
  }

  function renderQuestions() {
    const container = document.getElementById("exam-container");
    container.innerHTML = "";
    questions.forEach((q, idx) => {
      const div = document.createElement("div");
      div.className = "question-box";
      div.innerHTML = `<p><strong>Q${idx + 1}:</strong> ${q.question}</p>` +
        q.options.map((opt, i) =>
          `<label><input type='radio' name='q${idx}' value='${opt}' onchange='saveAnswer(${idx}, "${opt}")'> ${opt}</label><br>`
        ).join('');
      container.appendChild(div);
    });
  }

  function saveAnswer(qIndex, value) {
    answers[qIndex] = value;
  }

  function submitExam() {
    let score = 0;
    questions.forEach((q, idx) => {
      if (answers[idx] === q.answer) score++;
    });
    const percentage = (score / questions.length) * 100;
    const resultText = percentage >= 40
      ? `✅ Passed with ${percentage.toFixed(2)}%`
      : `❌ Failed with ${percentage.toFixed(2)}%`;
    document.getElementById("result").innerText = resultText;
    clearInterval(timerInterval);
  }

  let timerInterval;
  function startTimer() {
    timerInterval = setInterval(() => {
      const mins = Math.floor(duration / 60);
      const secs = duration % 60;
      timerElement.innerText = `⏱️ ${mins}m ${secs}s`;
      if (duration <= 0) {
        clearInterval(timerInterval);
        submitExam();
      }
      duration--;
    }, 1000);
  }

  loadQuestions();
</script>
