<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Exam</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      text-align: center;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .question {
      text-align: left;
      margin-bottom: 20px;
    }
    .submit-btn {
      padding: 10px 20px;
      font-size: 16px;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .submit-btn:hover {
      background: #0056b3;
    }
    .option {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="examTitle">Exam</h1>
    <form id="examForm"></form>
    <button class="submit-btn" onclick="submitExam()">Submit Exam</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const subject = localStorage.getItem("selectedSubject");
    const file = localStorage.getItem("selectedExamFile");
    const duration = parseInt(localStorage.getItem("selectedDuration")) || 30;
    const title = `${subject.toUpperCase()} Exam - ${file.replace(/\.json$/, "").replace(/_/g, " ").toUpperCase()}`;
    document.getElementById("examTitle").textContent = title;

    let questions = [];

    fetch(`../data/${subject}/${file}`)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data)) throw new Error("Invalid data format.");
        questions = data;
        renderQuestions(data);
      })
      .catch(err => {
        document.getElementById("examForm").innerHTML = "<p>Failed to load questions.</p>";
        console.error("Question Load Error:", err);
      });

    function renderQuestions(data) {
      const form = document.getElementById("examForm");
      form.innerHTML = "";

      data.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "question";
        div.innerHTML = `
          <p><b>Q${i + 1}:</b> ${q.question}</p>
          ${q.options.map((opt, idx) => `
            <div class="option">
              <label>
                <input type="radio" name="q${i}" value="${opt}" required />
                ${opt}
              </label>
            </div>
          `).join("")}
        `;
        form.appendChild(div);
      });
    }

    function submitExam() {
      const form = document.getElementById("examForm");
      const formData = new FormData(form);
      let correct = 0;

      questions.forEach((q, i) => {
        const answer = formData.get(`q${i}`);
        if (answer === q.answer) correct++;
      });

      const total = questions.length;
      const percent = Math.round((correct / total) * 100);
      const passed = percent >= 90;

      const statsKey = `${subject}_stats_${file}`;
      const lockKey = `${subject}_lock_${file}`;
      const stats = JSON.parse(localStorage.getItem(statsKey)) || { attempts: 0 };
      stats.attempts += 1;
      stats.status = passed ? "Passed" : "Failed";
      stats.lastScore = percent;
      localStorage.setItem(statsKey, JSON.stringify(stats));

      if (!passed) {
        const lockUntil = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 hours
        localStorage.setItem(lockKey, lockUntil.toISOString());
        alert(`❌ You scored ${percent}%. You need at least 90% to pass.\nYou can retry after 2 hours.`);
      } else {
        alert(`✅ Congratulations! You scored ${percent}%. Report will be downloaded.`);
        generateReport(percent, stats.attempts);
      }

      window.location.href = `${subject}_exam_dashboard.html`;
    }

    function generateReport(score, attempts) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Exam Report", 20, 20);
      doc.setFontSize(12);
      doc.text(`Subject: ${subject.toUpperCase()}`, 20, 30);
      doc.text(`Exam: ${file}`, 20, 40);
      doc.text(`Attempts: ${attempts}`, 20, 50);
      doc.text(`Score: ${score}%`, 20, 60);
      doc.text(`Status: Passed`, 20, 70);
      doc.text(`Completed At: ${new Date().toLocaleString()}`, 20, 80);

      doc.save(`${subject}_${file}_report.pdf`);
    }
  </script>
</body>
</html>
